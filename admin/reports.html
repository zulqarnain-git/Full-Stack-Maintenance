<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics | Admin Dashboard</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>Maint<span class="logo-alt">Sys</span></h2>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                    <li><a href="contracts.html"><i class="fas fa-file-contract"></i> <span>Contracts</span></a></li>
                    <li><a href="requests.html"><i class="fas fa-tools"></i> <span>Requests</span></a></li>
                    <li><a href="clients.html"><i class="fas fa-users"></i> <span>Clients</span></a></li>
                    <li><a href="representatives.html"><i class="fas fa-user-tie"></i> <span>Representatives</span></a></li>
                    <li><a href="upload-data.html"><i class="fas fa-upload"></i> <span>Upload Data</span></a></li>
                    <li class="active"><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="assets/img/user-profile.jpg" alt="Admin User" class="user-avatar"> <!-- Optional: add an image -->
                    <div class="user-info">
                        <span class="user-name">Admin User</span>
                        <span class="user-role">Administrator</span>
                    </div>
                </div>
                <a href="#" class="logout-btn" title="Logout"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                <h1>Reports & Analytics</h1>
                <p class="subheader">View and analyze key metrics for maintenance operations.</p>
            </header>

            <!-- Global Filters & Actions -->
            <section class="global-filters-actions card">
                <div class="card-body">
                    <div class="filter-grid">
                        <div class="filter-group date-range-group">
                            <label for="reportStartDate"><i class="fas fa-calendar-alt"></i> Date Range:</label>
                            <input type="date" id="reportStartDate" class="form-control">
                            <span>to</span>
                            <input type="date" id="reportEndDate" class="form-control">
                        </div>
                         <div class="filter-group">
                            <label for="reportQuickPeriod">Quick Period:</label>
                            <select id="reportQuickPeriod" class="form-control">
                                <option value="custom">Custom</option>
                                <option value="today">Today</option>
                                <option value="this_week">This Week</option>
                                <option value="last_7_days">Last 7 Days</option>
                                <option value="this_month" selected>This Month</option>
                                <option value="last_30_days">Last 30 Days</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="this_year">This Year</option>
                            </select>
                        </div>
                        <div class="action-group">
                             <button class="btn btn-primary" id="applyGlobalFiltersBtn">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline" id="exportOverallReportBtn">
                                <i class="fas fa-download"></i> Export Overview
                            </button>
                             <button class="btn btn-outline" id="printOverallReportBtn">
                                <i class="fas fa-print"></i> Print Overview
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tabs Navigation -->
            <section class="tabs-section">
                <div class="tabs-nav">
                    <button class="tab-link active" data-tab="summaryReport"><i class="fas fa-tachometer-alt"></i> Overall Summary</button>
                    <button class="tab-link" data-tab="requestsReport"><i class="fas fa-wrench"></i> Requests</button>
                    <button class="tab-link" data-tab="financialReport"><i class="fas fa-dollar-sign"></i> Financials</button>
                    <button class="tab-link" data-tab="performanceReport"><i class="fas fa-users-cog"></i> Team Performance</button>
                    <button class="tab-link" data-tab="partsReport"><i class="fas fa-cogs"></i> Parts Usage</button>
                </div>
            </section>
            
            <!-- Tab Content Area -->
            <div class="tab-content-area">
                <!-- Overall Summary Report Tab -->
                <div id="summaryReport" class="tab-pane active card">
                    <div class="card-header"><h3>Overall Summary Report</h3></div>
                    <div class="card-body">
                        <div class="report-summary-cards" id="overallSummaryCards">
                            <!-- KPI cards loaded by JS -->
                            <div class="kpi-card"><div class="icon"><i class="fas fa-spinner fa-spin"></i></div> <div class="text"><h4>Loading...</h4><p>Total Requests</p></div></div>
                            <div class="kpi-card"><div class="icon"><i class="fas fa-spinner fa-spin"></i></div> <div class="text"><h4>Loading...</h4><p>Total Revenue</p></div></div>
                            <div class="kpi-card"><div class="icon"><i class="fas fa-spinner fa-spin"></i></div> <div class="text"><h4>Loading...</h4><p>Avg. Completion</p></div></div>
                            <div class="kpi-card"><div class="icon"><i class="fas fa-spinner fa-spin"></i></div> <div class="text"><h4>Loading...</h4><p>Client Satisfaction</p></div></div>
                        </div>
                        <div class="report-charts-grid">
                            <div class="chart-container card"><div class="card-header"><h5>Requests Trend</h5></div><div class="card-body"><canvas id="summaryRequestsTrendChart"></canvas></div></div>
                            <div class="chart-container card"><div class="card-header"><h5>Revenue vs Cost</h5></div><div class="card-body"><canvas id="summaryRevenueCostChart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <!-- Requests Report Tab -->
                <div id="requestsReport" class="tab-pane card">
                    <div class="card-header"><h3>Maintenance Requests Report</h3></div>
                    <div class="card-body">
                        <div class="report-summary-cards" id="requestsSummaryCards"></div>
                        <div class="report-charts-grid">
                             <div class="chart-container card"><div class="card-header"><h5>Requests by Status</h5></div><div class="card-body"><canvas id="requestsByStatusChart"></canvas></div></div>
                             <div class="chart-container card"><div class="card-header"><h5>Requests by Type</h5></div><div class="card-body"><canvas id="requestsByTypeChart"></canvas></div></div>
                        </div>
                        <div class="detailed-table-container card mt-4">
                            <div class="card-header"><h5>Detailed Requests Data</h5></div>
                            <div class="card-body"><table id="requestsDetailedTable" class="display compact" style="width:100%;"></table></div>
                        </div>
                    </div>
                </div>

                <!-- Financial Report Tab -->
                <div id="financialReport" class="tab-pane card">
                    <div class="card-header"><h3>Financial Report</h3></div>
                    <div class="card-body">
                        <div class="report-summary-cards" id="financialSummaryCards"></div>
                        <div class="report-charts-grid">
                            <div class="chart-container card"><div class="card-header"><h5>Budget vs Actual by Client</h5></div><div class="card-body"><canvas id="budgetVsActualChart"></canvas></div></div>
                            <div class="chart-container card"><div class="card-header"><h5>Cost Breakdown (Parts vs Labor)</h5></div><div class="card-body"><canvas id="costBreakdownChart"></canvas></div></div>
                        </div>
                         <div class="detailed-table-container card mt-4">
                            <div class="card-header"><h5>Detailed Financial Transactions</h5></div>
                            <div class="card-body"><table id="financialDetailedTable" class="display compact" style="width:100%;"></table></div>
                        </div>
                    </div>
                </div>

                <!-- Team Performance Report Tab -->
                <div id="performanceReport" class="tab-pane card">
                     <div class="card-header"><h3>Team Performance Report</h3></div>
                    <div class="card-body">
                        <div class="report-summary-cards" id="performanceSummaryCards"></div>
                        <div class="report-charts-grid">
                            <div class="chart-container card"><div class="card-header"><h5>Top Performing Representatives</h5></div><div class="card-body"><canvas id="topPerformingRepsChart"></canvas></div></div>
                            <div class="chart-container card"><div class="card-header"><h5>Average Task Completion Time by Rep</h5></div><div class="card-body"><canvas id="avgCompletionTimeByRepChart"></canvas></div></div>
                        </div>
                        <div class="detailed-table-container card mt-4">
                            <div class="card-header"><h5>Detailed Representative Performance</h5></div>
                            <div class="card-body"><table id="performanceDetailedTable" class="display compact" style="width:100%;"></table></div>
                        </div>
                    </div>
                </div>

                <!-- Parts Usage Report Tab -->
                <div id="partsReport" class="tab-pane card">
                    <div class="card-header"><h3>Parts Usage Report</h3></div>
                     <div class="card-body">
                        <div class="report-summary-cards" id="partsSummaryCards"></div>
                        <div class="report-charts-grid">
                            <div class="chart-container card"><div class="card-header"><h5>Most Used Parts</h5></div><div class="card-body"><canvas id="mostUsedPartsChart"></canvas></div></div>
                            <div class="chart-container card"><div class="card-header"><h5>Parts Cost Trend</h5></div><div class="card-body"><canvas id="partsCostTrendChart"></canvas></div></div>
                        </div>
                        <div class="detailed-table-container card mt-4">
                            <div class="card-header"><h5>Detailed Parts Usage Data</h5></div>
                            <div class="card-body"><table id="partsDetailedTable" class="display compact" style="width:100%;"></table></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div>
                <p>Generating Report...</p>
            </div> -->
        </main>
    </div>

    <div id="toastNotification" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> <!-- Specific Chart.js version -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="reports_script.js"></script>
    <script>
        $(document).ready(function() {
    // --- Global State & Configuration ---
    let currentReportData = {};
    let activeTab = 'summaryReport'; // Default active tab
    let chartInstances = {};

    // Default date range (e.g., this month)
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    $('#reportStartDate').val(firstDayOfMonth.toISOString().split('T')[0]);
    $('#reportEndDate').val(lastDayOfMonth.toISOString().split('T')[0]);


    // --- Mock Data (WITH UPDATED DATES for requests) ---
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth(); // 0-11
    const prevMonth = currentMonth === 0 ? 11 : currentMonth -1;
    const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;


    const mockData = {
        requests: [
            // Data for current month relative to today
            { id: `REQ${currentYear}-CUR01`, client: 'ABC Corp', type: 'Repair', date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-02`, status: 'Completed', cost: 250, region: 'North', representative: 'John D', priority: 'High', timeToComplete: 48 },
            { id: `REQ${currentYear}-CUR02`, client: 'XYZ Inc', type: 'Maintenance', date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-05`, status: 'In Progress', cost: 120, region: 'South', representative: 'Jane S', priority: 'Medium', timeToComplete: null },
            { id: `REQ${currentYear}-CUR03`, client: 'Tech Solutions', type: 'Inspection', date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-08`, status: 'Pending', cost: 75, region: 'West', representative: null, priority: 'Low', timeToComplete: null },
            { id: `REQ${currentYear}-CUR04`, client: 'Global Co', type: 'Repair', date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-10`, status: 'Completed', cost: 150, region: 'East', representative: 'Lisa P', priority: 'Medium', timeToComplete: 24 },
            { id: `REQ${currentYear}-CUR05`, client: 'ABC Corp', type: 'Maintenance', date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-12`, status: 'Pending', cost: 180, region: 'North', representative: 'John D', priority: 'Low', timeToComplete: null },


            // Data for previous month relative to today
            { id: `REQ${prevMonthYear}-PREV01`, client: 'ABC Corp', type: 'Maintenance', date: `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-15`, status: 'Completed', cost: 200, region: 'North', representative: 'John D', priority: 'Medium', timeToComplete: 30 },
            { id: `REQ${prevMonthYear}-PREV02`, client: 'XYZ Inc', type: 'Repair', date: `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-20`, status: 'Completed', cost: 300, region: 'South', representative: 'Jane S', priority: 'High', timeToComplete: 60 },
            { id: `REQ${prevMonthYear}-PREV03`, client: 'Old Town Bakery', type: 'Inspection', date: `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-22`, status: 'Pending', cost: 90, region: 'Central', representative: null, priority: 'Low', timeToComplete: null },
            { id: `REQ${prevMonthYear}-PREV04`, client: 'Tech Solutions', type: 'Maintenance', date: `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-01`, status: 'Completed', cost: 180, region: 'West', representative: 'Mike B', priority: 'Medium', timeToComplete: 28 },
            { id: `REQ${prevMonthYear}-PREV05`, client: 'Global Co', type: 'Repair', date: `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-05`, status: 'In Progress', cost: 450, region: 'East', representative: 'Lisa P', priority: 'High', timeToComplete: null },
        ],
        financials: [
            { client: 'ABC Corp', period: `${currentYear}-Q1`, budgetAllocated: 5000, budgetSpent: 4500, revenueGenerated: 6000 },
            { client: 'XYZ Inc', period: `${currentYear}-Q1`, budgetAllocated: 7000, budgetSpent: 6800, revenueGenerated: 8000 },
            { client: 'Tech Solutions', period: `${currentYear}-Q1`, budgetAllocated: 3000, budgetSpent: 2500, revenueGenerated: 3500 },
        ],
        performance: [
            { representative: 'John D', region: 'North', assigned: 20, completed: 18, onTimeRate: 0.9, avgRating: 4.5, avgTimeToComplete: 40 },
            { representative: 'Jane S', region: 'South', assigned: 25, completed: 22, onTimeRate: 0.95, avgRating: 4.8, avgTimeToComplete: 35 },
            { representative: 'Mike B', region: 'West', assigned: 18, completed: 15, onTimeRate: 0.85, avgRating: 4.2, avgTimeToComplete: 50 },
        ],
        parts: [
            { partName: 'Oil Filter', category: 'Filters', used: 50, totalCost: 250, avgCost: 5 },
            { partName: 'Brake Pads', category: 'Brakes', used: 30, totalCost: 900, avgCost: 30 },
            { partName: 'Air Filter', category: 'Filters', used: 45, totalCost: 225, avgCost: 5 },
        ]
    };
    
    // --- Helper Functions ---
    function getCssVariableValue(variableName) {
        return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
    }

    function showLoading(show) {
        $('#loadingOverlay').toggleClass('show', show);
    }

    function showToast(message, type = 'info') {
        const $toast = $('#toastNotification');
        const $toastMessage = $('#toastMessage');
        $toastMessage.text(message);
        $toast.removeClass('success error info').addClass(type).addClass('show');
        setTimeout(() => $toast.removeClass('show'), 3000);
    }
    
    function destroyChart(chartId) {
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            delete chartInstances[chartId];
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            return new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (e) {
            return dateString; // Fallback if date is invalid
        }
    }

    function renderChart(canvasId, chartConfig, noDataMessage = "No data available for this chart.") {
        destroyChart(canvasId);
        const canvasElement = document.getElementById(canvasId);

        if (!canvasElement) {
            console.error(`Canvas element with ID #${canvasId} not found.`);
            $(canvasElement).parent().find('.no-data-message').remove(); // Clear previous message
            $(canvasElement).parent().append(`<p class="no-data-message text-muted text-center py-5">Error: Canvas not found.</p>`);
            return;
        }
        $(canvasElement).show();
        $(canvasElement).parent().find('.no-data-message').remove();

        let isEmptyData = false;
        if (chartConfig.data && chartConfig.data.datasets && chartConfig.data.datasets.length > 0) {
            isEmptyData = chartConfig.data.datasets.every(dataset => {
                if (!dataset.data || dataset.data.length === 0) return true;
                if (chartConfig.type === 'pie' || chartConfig.type === 'doughnut') {
                    return dataset.data.every(value => value === 0 || value === null || value === undefined);
                }
                return false; // For other charts, if data array exists, assume it's not empty unless explicitly checked
            });
            if ((chartConfig.type === 'pie' || chartConfig.type === 'doughnut') && (!chartConfig.data.labels || chartConfig.data.labels.length === 0)) {
                isEmptyData = true;
            }
        } else {
            isEmptyData = true;
        }
        
        if (isEmptyData) {
            console.warn(`No data to render chart #${canvasId}. Displaying message.`);
            $(canvasElement).hide(); 
            $(canvasElement).parent().append(`<p class="no-data-message text-muted text-center py-5">${noDataMessage}</p>`);
            return;
        }

        const ctx = canvasElement.getContext('2d');
        if (!ctx) {
            console.error(`Failed to get 2D context for canvas #${canvasId}.`);
            return;
        }
        
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { mode: 'index', intersect: false }
            }
        };

        chartInstances[canvasId] = new Chart(ctx, {
            ...chartConfig,
            options: { ...defaultOptions, ...chartConfig.options } 
        });
    }


    // --- Date Range Quick Select ---
    $('#reportQuickPeriod').on('change', function() {
        const period = $(this).val();
        const today = new Date();
        let startDate = new Date(today); 
        let endDate = new Date(today);  

        switch (period) {
            case 'today':
                break;
            case 'this_week':
                const currentDay = today.getDay();
                startDate.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1)); 
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
            case 'last_7_days':
                 startDate.setDate(today.getDate() - 6);
                break;
            case 'this_month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'last_30_days':
                 startDate.setDate(today.getDate() - 29);
                break;
            case 'this_quarter':
                const quarter = Math.floor(today.getMonth() / 3);
                startDate = new Date(today.getFullYear(), quarter * 3, 1);
                endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                break;
            case 'this_year':
                startDate = new Date(today.getFullYear(), 0, 1);
                endDate = new Date(today.getFullYear(), 11, 31);
                break;
            case 'custom':
                return; 
        }
        $('#reportStartDate').val(startDate.toISOString().split('T')[0]);
        $('#reportEndDate').val(endDate.toISOString().split('T')[0]);
    });


    // --- Tab Switching Logic ---
    $('.tab-link').on('click', function() {
        const tabId = $(this).data('tab');
        if (activeTab === tabId && !$('#loadingOverlay').hasClass('show')) return; 

        activeTab = tabId;
        $('.tab-link').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').removeClass('active');
        $('#' + tabId).addClass('active');
        generateAndDisplayReport();
    });

    // --- Report Generation ---
    function generateAndDisplayReport() {
        showLoading(true);
        setTimeout(() => {
            const startDateStr = $('#reportStartDate').val();
            const endDateStr = $('#reportEndDate').val();

            if (!startDateStr || !endDateStr || new Date(startDateStr) > new Date(endDateStr)) {
                showToast("Invalid date range selected.", "error");
                showLoading(false);
                return;
            }
            
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0); // Start of the day
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999); // End of the day

            const filteredRequests = mockData.requests.filter(r => {
                const reqDate = new Date(r.date);
                return reqDate >= startDate && reqDate <= endDate;
            });
            
            // console.log(`Filtering from ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
            // console.log(`Found ${filteredRequests.length} requests for tab ${activeTab}`);


            if (activeTab === 'summaryReport') {
                renderSummaryReport(filteredRequests, mockData.financials, mockData.performance);
            } else if (activeTab === 'requestsReport') {
                renderRequestsReport(filteredRequests);
            } else if (activeTab === 'financialReport') {
                renderFinancialReport(mockData.financials, filteredRequests);
            } else if (activeTab === 'performanceReport') {
                renderPerformanceReport(mockData.performance, filteredRequests);
            } else if (activeTab === 'partsReport') {
                renderPartsReport(mockData.parts, filteredRequests);
            }
            showLoading(false);
        }, 500); 
    }
    
    // --- Render Functions for Each Tab ---
    
    function renderSummaryReport(requests, financials, performance) {
        const totalReq = requests.length;
        const totalRev = financials.reduce((sum, item) => sum + item.revenueGenerated, 0);
        const avgOnTime = performance.length > 0 ? (performance.reduce((sum, item) => sum + item.onTimeRate,0)/performance.length * 100).toFixed(0) + '%' : 'N/A';
        const avgRating = performance.length > 0 ? (performance.reduce((sum,item) => sum + item.avgRating, 0)/performance.length).toFixed(1) : 'N/A';

        $('#overallSummaryCards').html(`
            <div class="kpi-card"><div class="icon"><i class="fas fa-wrench"></i></div> <div class="text"><h4>${totalReq}</h4><p>Total Requests</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-dollar-sign"></i></div> <div class="text"><h4>$${totalRev.toLocaleString()}</h4><p>Total Revenue</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-check-circle"></i></div> <div class="text"><h4>${avgOnTime}</h4><p>Avg. On-Time</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-star"></i></div> <div class="text"><h4>${avgRating}</h4><p>Avg. Rep Rating</p></div></div>
        `);

        const monthlyRequests = Array(12).fill(0);
        requests.forEach(req => {
            const month = new Date(req.date).getMonth();
            monthlyRequests[month]++;
        });
        const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        renderChart('summaryRequestsTrendChart', {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{ 
                    label: 'Requests', 
                    data: monthlyRequests, 
                    borderColor: getCssVariableValue('--primary-color'), 
                    backgroundColor: getCssVariableValue('--primary-color') + '33', 
                    tension: 0.1,
                    fill: true 
                }]
            }
        });

        renderChart('summaryRevenueCostChart', {
            type: 'bar',
            data: {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'], 
                datasets: [
                    { label: 'Revenue', data: [totalRev * 0.2, totalRev * 0.3, totalRev * 0.25, totalRev * 0.25], backgroundColor: getCssVariableValue('--success-color') },
                    { label: 'Cost', data: [totalRev*0.1, totalRev*0.15, totalRev*0.12, totalRev*0.13], backgroundColor: getCssVariableValue('--danger-color') }
                ]
            }
        });
    }

    function renderRequestsReport(requests) {
        const total = requests.length;
        const completed = requests.filter(r => r.status === 'Completed').length;
        const pending = requests.filter(r => r.status === 'Pending').length;
        const inProgress = requests.filter(r => r.status === 'In Progress').length;
        const rejected = requests.filter(r => r.status === 'Rejected').length || 0; // Ensure 0 if none

        $('#requestsSummaryCards').html(`
            <div class="kpi-card"><div class="icon"><i class="fas fa-list-alt"></i></div><div class="text"><h4>${total}</h4><p>Total Requests</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-check"></i></div><div class="text"><h4>${completed}</h4><p>Completed</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-hourglass-half"></i></div><div class="text"><h4>${pending}</h4><p>Pending</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-cogs"></i></div><div class="text"><h4>${inProgress}</h4><p>In Progress</p></div></div>
        `);

        renderChart('requestsByStatusChart', {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending', 'In Progress', 'Rejected'],
                datasets: [{ data: [completed, pending, inProgress, rejected], backgroundColor: [getCssVariableValue('--success-color'), getCssVariableValue('--warning-color'), getCssVariableValue('--info-color'), getCssVariableValue('--danger-color')] }]
            }
        });
        
        const typeCounts = requests.reduce((acc, req) => { acc[req.type] = (acc[req.type] || 0) + 1; return acc; }, {});
        renderChart('requestsByTypeChart', {
            type: 'pie',
            data: {
                labels: Object.keys(typeCounts),
                datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#9b59b6', '#34495e', '#1abc9c', '#e67e22', '#f1c40f', '#2ecc71'].slice(0, Object.keys(typeCounts).length) }]
            }
        });
        
        const tableId = '#requestsDetailedTable';
        if ($.fn.DataTable.isDataTable(tableId)) {
            $(tableId).DataTable().clear().rows.add(requests).draw();
        } else {
            $(tableId).DataTable({
                data: requests,
                columns: [
                    { title: 'ID', data: 'id' }, { title: 'Client', data: 'client' },
                    { title: 'Date', data: 'date', render: formatDate }, { title: 'Type', data: 'type' },
                    { title: 'Status', data: 'status' }, { title: 'Cost ($)', data: 'cost', render: d => d.toFixed(2) },
                    { title: 'Region', data: 'region' }
                ],
                responsive: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });
        }
    }
    
    // --- Other render functions (financial, performance, parts) as before ---
    // Make sure they also use the refined `renderChart` and handle `filteredRequests` or relevant data
    function renderFinancialReport(financials, requests) { 
        const totalBudgetAlloc = financials.reduce((acc, f) => acc + f.budgetAllocated, 0);
        const totalBudgetSpent = financials.reduce((acc, f) => acc + f.budgetSpent, 0);
        const totalRevenue = financials.reduce((acc, f) => acc + f.revenueGenerated, 0);
        const totalRequestCost = requests.reduce((acc, r) => acc + r.cost, 0);


        $('#financialSummaryCards').html(`
            <div class="kpi-card"><div class="icon"><i class="fas fa-wallet"></i></div><div class="text"><h4>$${totalBudgetAlloc.toLocaleString()}</h4><p>Total Budget</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-money-bill-wave"></i></div><div class="text"><h4>$${totalBudgetSpent.toLocaleString()}</h4><p>Total Spent (Contracts)</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-chart-line"></i></div><div class="text"><h4>$${totalRevenue.toLocaleString()}</h4><p>Total Revenue</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-file-invoice-dollar"></i></div><div class="text"><h4>$${totalRequestCost.toLocaleString()}</h4><p>Total Request Costs</p></div></div>
        `);

        renderChart('budgetVsActualChart', {
            type: 'bar',
            data: {
                labels: financials.map(f => f.client),
                datasets: [
                    { label: 'Allocated', data: financials.map(f => f.budgetAllocated), backgroundColor: getCssVariableValue('--info-color') + '99'},
                    { label: 'Spent', data: financials.map(f => f.budgetSpent), backgroundColor: getCssVariableValue('--warning-color') + '99'}
                ]
            },
            options: { indexAxis: 'y' }
        });
        
        const totalPartsCost = mockData.parts.reduce((sum, p) => sum + p.totalCost, 0); 
        const estimatedLaborCost = totalRequestCost - totalPartsCost;

        renderChart('costBreakdownChart', {
            type: 'pie',
            data: {
                labels: ['Parts Cost', 'Labor Cost (Est.)'],
                datasets: [{ data: [totalPartsCost, Math.max(0, estimatedLaborCost)], backgroundColor: [getCssVariableValue('--primary-color'), getCssVariableValue('--secondary-color')]}]
            }
        });

        const tableId = '#financialDetailedTable';
        if ($.fn.DataTable.isDataTable(tableId)) {
            $(tableId).DataTable().clear().rows.add(financials).draw();
        } else {
            $(tableId).DataTable({
                data: financials,
                columns: [
                    { title: 'Client', data: 'client' }, { title: 'Period', data: 'period' },
                    { title: 'Budget Allocated ($)', data: 'budgetAllocated', render: d => d.toLocaleString() },
                    { title: 'Budget Spent ($)', data: 'budgetSpent', render: d => d.toLocaleString() },
                    { title: 'Revenue Generated ($)', data: 'revenueGenerated', render: d => d.toLocaleString() }
                ],
                responsive: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });
        }
    }

    function renderPerformanceReport(performance, requests) {
        const avgOnTime = performance.length > 0 ? (performance.reduce((acc,p) => acc + p.onTimeRate, 0) / performance.length * 100).toFixed(1) + '%' : 'N/A';
        const avgRating = performance.length > 0 ? (performance.reduce((acc,p) => acc + p.avgRating, 0) / performance.length).toFixed(1) : 'N/A';
        const totalCompletedByReps = performance.reduce((acc,p) => acc + p.completed, 0);

         $('#performanceSummaryCards').html(`
            <div class="kpi-card"><div class="icon"><i class="fas fa-users"></i></div><div class="text"><h4>${performance.length}</h4><p>Tracked Reps</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-tasks"></i></div><div class="text"><h4>${totalCompletedByReps}</h4><p>Total Tasks by Reps</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-thumbs-up"></i></div><div class="text"><h4>${avgRating} <i class="fas fa-star text-yellow-400"></i></h4><p>Avg. Rep Rating</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-stopwatch"></i></div><div class="text"><h4>${avgOnTime}</h4><p>Avg. On-Time Rate</p></div></div>
        `);
        
        const topRepsData = [...performance].sort((a,b) => b.avgRating - a.avgRating).slice(0,5);
        renderChart('topPerformingRepsChart', {
            type: 'bar',
            data: {
                labels: topRepsData.map(p => p.representative),
                datasets: [{label: 'Avg Rating', data: topRepsData.map(p => p.avgRating), backgroundColor: getCssVariableValue('--info-color')}]
            }
        });

        renderChart('avgCompletionTimeByRepChart', {
            type: 'line',
            data: {
                labels: performance.map(p => p.representative),
                datasets: [{label: 'Avg Comp. Time (hrs)', data: performance.map(p => p.avgTimeToComplete), borderColor: getCssVariableValue('--warning-color'), tension: 0.1}]
            }
        });
        
        const tableId = '#performanceDetailedTable';
        if ($.fn.DataTable.isDataTable(tableId)) {
            $(tableId).DataTable().clear().rows.add(performance).draw();
        } else {
            $(tableId).DataTable({
                data: performance,
                columns: [
                    { title: 'Representative', data: 'representative' }, { title: 'Region', data: 'region' },
                    { title: 'Assigned', data: 'assigned' }, { title: 'Completed', data: 'completed' },
                    { title: 'On-Time Rate', data: 'onTimeRate', render: d => `${(d*100).toFixed(1)}%` },
                    { title: 'Avg Rating', data: 'avgRating' }
                ],
                responsive: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });
        }
    }

    function renderPartsReport(parts, requests) { 
        const totalPartsUsed = parts.reduce((acc,p) => acc + p.used, 0);
        const totalPartsCost = parts.reduce((acc,p) => acc + p.totalCost, 0);
        const uniqueParts = parts.length;

        $('#partsSummaryCards').html(`
            <div class="kpi-card"><div class="icon"><i class="fas fa-cog"></i></div><div class="text"><h4>${uniqueParts}</h4><p>Unique Parts Types</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-cart-plus"></i></div><div class="text"><h4>${totalPartsUsed}</h4><p>Total Units Used</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-tags"></i></div><div class="text"><h4>$${totalPartsCost.toLocaleString()}</h4><p>Total Parts Cost</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-balance-scale"></i></div><div class="text"><h4>$${(totalPartsUsed > 0 ? totalPartsCost/totalPartsUsed : 0).toFixed(2)}</h4><p>Avg Cost/Unit</p></div></div>
        `);

        const topPartsData = [...parts].sort((a,b) => b.used - a.used).slice(0, Math.min(5, parts.length));
        renderChart('mostUsedPartsChart', {
            type: 'pie',
            data: {
                labels: topPartsData.map(p => p.partName),
                datasets: [{ data: topPartsData.map(p => p.used), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'].slice(0, topPartsData.length)}]
            }
        });
        
        const costByCat = parts.reduce((acc, part) => {
            acc[part.category] = (acc[part.category] || 0) + part.totalCost;
            return acc;
        }, {});
         renderChart('partsCostTrendChart', {
            type: 'bar',
            data: {
                labels: Object.keys(costByCat),
                datasets: [{label: 'Total Cost by Category', data: Object.values(costByCat), backgroundColor: getCssVariableValue('--primary-color') + '99'}]
            }
        });

        const tableId = '#partsDetailedTable';
        if ($.fn.DataTable.isDataTable(tableId)) {
            $(tableId).DataTable().clear().rows.add(parts).draw();
        } else {
            $(tableId).DataTable({
                data: parts,
                columns: [
                    { title: 'Part Name', data: 'partName' }, { title: 'Category', data: 'category' },
                    { title: 'Units Used', data: 'used' }, 
                    { title: 'Total Cost ($)', data: 'totalCost', render: d => d.toLocaleString()},
                    { title: 'Avg Cost/Unit ($)', data: 'avgCost', render: d => d.toFixed(2)}
                ],
                responsive: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });
        }
    }


    // --- Event Handlers ---
    $('#applyGlobalFiltersBtn').on('click', generateAndDisplayReport);

    // Initial report generation
    $('#reportQuickPeriod').val('this_month').trigger('change'); // Set default and trigger date update
    generateAndDisplayReport(); // Initial load for the default active tab

    // --- Sidebar Toggle & Other UI ---
    const $sidebar = $('.sidebar');
    $('#sidebarToggle').on('click', function() { $sidebar.toggleClass('open'); });
    $(document).on('click', function(event) {
        if ($(window).width() < 992 && $sidebar.hasClass('open') && !$(event.target).closest('.sidebar').length && !$(event.target).closest('#sidebarToggle').length) {
            $sidebar.removeClass('open');
        }
    });

    $('#exportOverallReportBtn').on('click', () => showToast('Overall report export process would start here.', 'info'));
    $('#printOverallReportBtn').on('click', () => { 
        showToast('Preparing overview for printing...', 'info'); 
        // Could be window.print() or a more targeted print function
    });
});
    </script>
</body>
</html>